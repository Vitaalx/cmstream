<div class="max-w-[1164px] h-[calc(100vh-100px)] pt-[20px] mx-auto px-7 lg:px-14 content">
    <delete_movie_modal
    cv-if="this.isDeleteModalOpen" :movieid="this.movieId"
    @close="this.isDeleteModalOpen = false"
    @ondelete="refresh"
    />

    <div class="table w-full">
        <div class="table-header w-full flex justify-between items-start mb-[10px]">
            <div class="search-movie">
                <div class="search-bar border rounded-[8px] px-[20px] py-[10px] flex items-center">
                    <icon name="magnify" class="text-xl mr-[10px]"/>
    
                    <input class="focus:outline-none" cv-model="search" type="text" placeholder="Rechercher">
                </div>
    
                <p class="mt-[10px] px-[20px] py-[10px]">{{ this.searchInfo }}</p>
            </div>

            <router_link href="/admin/add-content?type=movie" class="add-movie-btn flex items-center gap-[10px] px-[20px] py-[10px] rounded-[8px] bg-skyblue hover:bg-[#1da1f2] text-white">
                <icon name="plus" class="text-xl"/>
                <span class="mt-[-2px]">Ajouter un film</span>
        </div>

        <span cv-if="!this.displayedMovies.length">Aucun film trouvé.</span>

        <table cv-if="this.displayedMovies.length" class="table-content w-full text-left border-2 rounded-t-[8px]" cv-if="this.displayedMovies.length !== 0">
            <thead class="bg-whitesmoke"> 
                <tr>
                    <th class="p-[22px] cursor-pointer" @click="this.sortByTitle()">
                        Titre <icon name="arrow-down-thick" class="ml-[8px]"/>
                    </th>

                    <th class="p-[22px] cursor-pointer" @click="this.sortByCategory()">
                        Catégorie <icon name="arrow-down-thick" class="ml-[8px]"/>
                    </th>

                    <th class="p-[22px] cursor-pointer" @click="this.sortByAddDate()">
                        Ajouté le <icon name="arrow-down-thick" class="ml-[8px]"/>
                    </th>

                    <th class="p-[22px] cursor-pointer" @click="this.sortByUpdateDate()">
                        Modifier le <icon name="arrow-down-thick" class="ml-[8px]"/>
                    </th>

                    <th class="p-[22px]">Actions</th>
                </tr>
            </thead>

            <tbody>
                <tr class="border-2" cv-for="movie of this.displayedMovies">
                    <td class="p-[22px]">{{ this.movie.title }}</td>

                    <td class="p-[22px]">{{ this.movie.category ? this.movie.category.title : "Aucune" }}</td>

                    <td class="p-[22px]">{{ this.dateFormater(this.movie.created_at) }}</td>

                    <td class="p-[22px]">{{ this.dateFormater(this.movie.updated_at) }}</td>
                    
                    <td class="p-[22px]">
                        <icon
                        name="trash-can-outline"
                        class="text-2xl text-pinkred cursor-pointer"
                        @click="this.openDeleteModal(this.movie.id)"
                        />

                        <router_link :href="`/admin/edit-video/movie/${this.movie.id}`">
                            <icon
                            name="square-edit-outline"
                            class="text-2xl ml-[14px] text-darkgrey cursor-pointer"
                            />
                        </router_link>
                    </td>
                </tr>
            </tbody>
        </table>

        <div cv-if="this.displayedMovies.length" class="table-footer w-full flex items-center justify-between px-[25px] border-x-[2px] border-b-[2px] p-[12px] rounded-b-[8px]">
            <button @click="this.previousPage()" class="px-[20px] py-[10px] border rounded-[8px]">Précédant</button>

            <span>Page {{ this.currentPageNumber }} sur {{ this.maxPage }}</span>
            
            <button @click="this.nextPage()" class="px-[20px] py-[10px] border rounded-[8px]">Suivant</button>
        </div>
    </div>
</div>

<script>
    const [impLoader, impTaob, delete_movie_modal] = await Promise.all([
        import("/public/cuteVue/loader.js"),
        import("/public/cuteVue/taob.js"),
        importer('/public/cuteVue/components/modals/delete_movie_modal.html'),
    ]);
    const loaderStore = impLoader.loaderStore;
    const taob = impTaob.default;

    export default {
        components: {
            delete_movie_modal,
        },
        data: {
            displayedMovies: [],
            movies: [],
            movieFiltered: [],
            movieId: null,
            currentPageNumber: 1,
            maxPage: 0,
            isOpenedModal: false,
            currentTitle: "",
            currentCategory: "",
            currentCreatedAt: "",
            currentUpdatedAt: "",
            isDeleteModalOpen: false,
            search: "",
            nbTotalMovies: 0,
            limitToDisplay: 5,
            searchInfo: ""
        },
        watch: {
            search(val) {
                if (val === "") {
                    this.searchInfo = "";
                    this.displayedMovies = this.movies;

                    return;
                }

                this.searchMovies(val);
            }
        },
        methods: {
            async getMoviesWithPaging(page, count = false) {
                let close = loaderStore.push();

                await taob.get(`movies?page=${page - 1}`).s(data => {
                    this.movies = data;
                }).result;

                this.displayedMovies = this.movies;

                if (count) {
                    await taob.get("movies/count").s(data => {
                        this.nbTotalMovies = data.count;
                    }).result;

                    this.getNbPages();
                }

                close();
            },
            async searchMovies(val) {
                let close = loaderStore.push();

                await taob.get(`movies?title=${val}`).s(data => {
                    this.movieFiltered = data;
                    console.log("data " + data);
                }).result;

                if (this.movieFiltered.length > 0) {
                    this.searchInfo = "";
                    this.displayedMovies = this.movieFiltered;
                } else {
                    console.log("Aucun résultat trouvé pour cette recherche.");
                    this.searchInfo = "Aucun résultat trouvé pour cette recherche.";
                    this.displayedMovies = this.movies;
                }

                console.log(this.movies);

                close();
            },
            sortByTitle() {
                this.displayedMovies = this.displayedMovies.sort((a, b) => {
                    if (a.title < b.title) return -1;
                    if (a.title > b.title) return 1;

                    return 0;
                });
            },
            sortByCategory() {
                this.displayedMovies = this.displayedMovies.sort((a, b) => {
                    if (a.category < b.category) return -1;
                    if (a.category > b.category) return 1;

                    return 0;
                });
            },
            sortByAddDate() {
                this.displayedMovies = this.displayedMovies.sort((a, b) => {
                    if (a.created_at < b.created_at) return -1;
                    if (a.created_at > b.created_at) return 1;

                    return 0;
                });
            },
            sortByUpdateDate() {
                this.displayedMovies = this.displayedMovies.sort((a, b) => {
                    if (a.updated_at < b.updated_at) return -1;
                    if (a.updated_at > b.updated_at) return 1;

                    return 0;
                });
            },
            async previousPage() {
                if (this.currentPageNumber === 1) return;

                this.currentPageNumber--;
                await this.getMoviesWithPaging(this.currentPageNumber);
            },
            async nextPage() {
                if (this.currentPageNumber === this.maxPage) return;

                this.currentPageNumber++;
                await this.getMoviesWithPaging(this.currentPageNumber);
            },
            openDeleteModal(movieId) {
                this.movieId = movieId;
                this.isDeleteModalOpen = true;
            },
            closeDeleteModal() {
                this.isDeleteModalOpen = false;
            },
            async refresh(action) {
                if (action === "delete") {
                    if (this.displayedMovies.length === 1 && this.currentPageNumber > 1) {
                        this.currentPageNumber--;
                    }
                }

                await this.getMoviesWithPaging(this.currentPageNumber, true);
            },
            getNbPages() {
                this.maxPage = Math.ceil(this.nbTotalMovies / this.limitToDisplay);
            },
            dateFormater(date){
                const parts = date.split("-");
                const year = parts[0];
                const month = parts[1];
                const day = parts[2];

                return day + "/" + month + "/" + year;
            },
        },
        mounted() {
            this.getMoviesWithPaging(this.currentPageNumber, true);
        }
    }
</script>

<style>

</style>